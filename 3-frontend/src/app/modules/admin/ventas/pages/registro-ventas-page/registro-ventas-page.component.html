<div class="flex flex-col flex-auto w-full">
    <div class="flex flex-wrap w-full  mx-auto p-6 md:p-8">
        <!-- Título y acciones -->
        <div class="flex items-center justify-between w-full">
            <h2 class="text-2xl md:text-3xl font-semibold tracking-tight leading-8">Nueva Venta</h2>
        </div>
        <!-- Contenedor de búsqueda -->
        <div class="w-full xl:col-span-2 mt-6 relative">
            <div class="relative">
                <input maxlength="50"
                    [disabled]="isbuscandoProductosDisabled || isCallingInsertService || disabledSearch" type="text"
                    [(ngModel)]="parametroBusquedaProducto" (keyup.enter)="keyupEnterProductos($event)"
                    (input)="filtrarProductos($event)" placeholder="Buscar Producto"
                    class="w-full p-3 pl-10 border border-gray-300 rounded-xl bg-card shadow focus:ring focus:ring-primary-300 focus:outline-none placeholder:text-gray-500">
                <mat-icon class="absolute left-3 top-3 text-gray-500" [svgIcon]="'heroicons_mini:magnifying-glass'"
                    (click)="keyupEnterProductos($event)"></mat-icon>
            </div>
            <!-- DropDown de Búsqueda -->
            <div *ngIf="allProductoDataSource.data.length > 0"
                class="absolute w-auto mt-2 bg-white shadow-lg rounded-xl border border-gray-300 overflow-hidden max-h-72 overflow-y-auto z-50 transition-all duration-200 ease-in-out">
                <table class="w-auto text-left">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 text-sm font-semibold">Imagen</th>
                            <th class="p-2 text-sm font-semibold">Código</th>
                            <th class="p-2 text-sm font-semibold">Nombre</th>
                            <th class="p-2 text-sm font-semibold">Stock</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let producto of allProductoDataSource.data" class="cursor-pointer hover:bg-gray-200"
                            (click)="seleccionarProducto(producto)">
                            <td class="min-w-10">
                                <div class="flex items-center">
                                    <div
                                        class="relative flex items-center justify-center w-12 h-12 mr-6 rounded overflow-hidden border">
                                        <img *ngIf="producto.urlFoto" [alt]="'Imagen de ' + producto.nombre"
                                            [src]="producto.urlFoto" class="w-full h-full object-cover">
                                        <div *ngIf="!producto.urlFoto"
                                            class="flex items-center justify-center w-full h-full text-xs font-semibold leading-none text-center uppercase bg-gray-200">
                                            SIN IMAGEN
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="p-2 text-sm">{{ producto.codigo }}</td>
                            <td class="p-2 text-sm">{{ producto.nombre }}</td>
                            <td class="p-2 text-sm">
                                <span
                                    class="inline-flex items-center font-bold text-xs px-2.5 py-0.5 rounded-full tracking-wide uppercase"
                                    [ngClass]="{'bg-red-200 text-red-800 dark:bg-red-600 dark:text-red-50': producto?.stock <= 0,
                        'bg-orange-200 text-orange-800 dark:bg-orange-600 dark:text-orange-50': producto?.stock > 0 && producto?.stock <= 5,
                        'bg-green-200 text-green-800 dark:bg-green-600 dark:text-green-50': producto?.stock > 5
                        }"> <span class="leading-relaxed whitespace-nowrap">{{producto?.stock}}</span>
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="w-full xl:col-span-2 mt-6 relative">
            <mat-button-toggle-group class="flex flex-wrap -m-2" (change)="onSelectCategoryProduct($event)">
                <ng-container *ngFor="let category of allCategoriesDataSource">
                    <mat-button-toggle class="m-2" [value]="category">
                        <span class="text-secondary">{{category.nombre}}</span>
                        <span class="ml-1.5 font-medium text-secondary">({{category.cantidadProductos}})</span>
                    </mat-button-toggle>
                </ng-container>
            </mat-button-toggle-group>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-5 w-full mt-8">
            <!-- Tabla de Productos Seleccionados -->
            <div class="xl:col-span-3 flex flex-col flex-auto bg-card shadow rounded-2xl overflow-hidden">
                <div class="overflow-x-auto md:overflow-visible mx-6">
                    <table *ngIf="lstProductosSeleccionados?.data.length > 0" class="w-full bg-transparent" mat-table
                        matSort [dataSource]="lstProductosSeleccionados" [trackBy]="trackByFn" #productosSeleccionados>
                        <!-- Imagen del producto -->
                        <ng-container matColumnDef="foto">
                            <th mat-header-cell *matHeaderCellDef>Imagen</th>
                            <td mat-cell *matCellDef="let producto" class="min-w-10">
                                <div class="flex items-center">
                                    <div
                                        class="relative flex items-center justify-center w-12 h-12 mr-6 rounded overflow-hidden border">
                                        <img *ngIf="producto?.urlFoto" [alt]="'Imagen de ' +producto?.nombre"
                                            [src]="producto?.urlFoto" class="w-full h-full object-cover">
                                        <div *ngIf="!producto?.urlFoto"
                                            class="flex items-center justify-center w-full h-full text-xs font-semibold leading-none text-center uppercase bg-gray-200">
                                            SIN IMAGEN
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </ng-container>
                        <!-- Nombre -->
                        <ng-container matColumnDef="nombre">
                            <th mat-header-cell mat-sort-header *matHeaderCellDef>
                                Nombre
                            </th>
                            <td mat-cell *matCellDef="let producto" class="min-w-30">
                                <span class="flex items-center">
                                    <span class="ml-3 break-words max-w-[150px]">{{producto.nombre}}</span>
                                </span>
                            </td>
                        </ng-container>
                        <!-- Stock -->
                        <ng-container matColumnDef="stock">
                            <th mat-header-cell mat-sort-header *matHeaderCellDef class="text-center">
                                Stock
                            </th>
                            <td mat-cell *matCellDef="let producto" class="min-w-10 text-center">
                                <span
                                    class="inline-flex items-center font-bold text-xs px-2.5 py-0.5 rounded-full tracking-wide uppercase"
                                    [ngClass]="{
                        'bg-red-200 text-red-800 dark:bg-red-600 dark:text-red-50': producto?.stock <= 0,
                        'bg-orange-200 text-orange-800 dark:bg-orange-600 dark:text-orange-50': producto?.stock > 0 && producto?.stock <= 5,
                        'bg-green-200 text-green-800 dark:bg-green-600 dark:text-green-50': producto?.stock > 5
                        }">
                                    <span class="leading-relaxed whitespace-nowrap">{{producto?.stock}}</span>
                                </span>
                            </td>
                        </ng-container>
                        <!-- Precio Venta -->
                        <ng-container matColumnDef="precioVenta">
                            <th mat-header-cell mat-sort-header *matHeaderCellDef class="min-w-10"> Precio
                            </th>
                            <td mat-cell *matCellDef="let producto">
                                <span style="color: #056DB6;" class="pr-6 w-auto h-auto rounded-full">
                                    {{ producto.precioVenta |
                                    currency:monedaInfo.codigoMoneda:'code':'':
                                    monedaInfo.cultureInfo }}
                                </span>
                            </td>
                        </ng-container>
                        <!--  Cantidad -->
                        <ng-container matColumnDef="cantidad">
                            <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                            <td mat-cell *matCellDef="let producto">
                                <div class="flex items-center space-x-2">
                                    <!-- Botón disminuir -->
                                    <button mat-icon-button color="primary" [disabled]="isCallingInsertService"
                                        (click)="disminuirCantidad(producto)">
                                        <mat-icon>remove</mat-icon>
                                    </button>
                                    <!-- Input de cantidad -->
                                    <input type="number" [disabled]="isCallingInsertService"
                                        [(ngModel)]="producto.cantidad" class="w-16 text-center border rounded-md"
                                        min="1" readonly>
                                    <!-- Botón aumentar -->
                                    <button mat-icon-button color="primary" [disabled]="isCallingInsertService"
                                        (click)="aumentarCantidad(producto)">
                                        <mat-icon>add</mat-icon>
                                    </button>
                                </div>
                            </td>
                        </ng-container>
                        <!-- Total -->
                        <ng-container matColumnDef="total">
                            <th mat-header-cell mat-sort-header *matHeaderCellDef>
                                Total
                            </th>
                            <td mat-cell *matCellDef="let producto">
                                <span style="color: #056DB6;" class="pr-6 w-auto h-auto rounded-full">
                                    {{ calcularTotalProducto(producto) | currency: monedaInfo.codigoMoneda:'code':'':
                                    monedaInfo.cultureInfo }}
                                </span>
                            </td>
                        </ng-container>
                        <!-- Acciones -->
                        <ng-container matColumnDef="acciones">
                            <th mat-header-cell mat-sort-header *matHeaderCellDef> Acciones </th>
                            <td mat-cell *matCellDef="let producto">
                                <button mat-icon-button color="warn" (click)="quitarProducto(producto)" class="p-1"
                                    [disabled]="disabledAcciones || isCallingInsertService">
                                    <mat-icon svgIcon="feather:trash-2"></mat-icon>
                                </button>
                            </td>
                        </ng-container>
                        <tr mat-header-row *matHeaderRowDef="productoTableColumns"></tr>
                        <tr class="order-row h-16" mat-row *matRowDef="let row; columns: productoTableColumns;"></tr>
                    </table>
                    <!-- Cards de productos seleccionados -->

                    <div class="skeleton-default  bg-card shadow rounded-2xl overflow-hidden " *ngIf="skeleton">
                        <ngx-skeleton-loader [count]="skeletonNumber"
                            [theme]="{ 'border-radius': '0', height: '50px' }"></ngx-skeleton-loader>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5 mt-6 "
                        *ngIf="!skeleton">
                        <mat-card *ngFor="let producto of allProductByCategoryDataSource | slice: startIndex : endIndex"
                            class="flex flex-col items-center transform transition-transform hover:scale-105 hover:shadow-xl border border-gray-200 rounded-2xl shadow-lg p-4">

                            <!-- Imagen del producto -->
                            <div class="w-24 h-24 mb-4 rounded-xl overflow-hidden border border-gray-300">
                                <img *ngIf="producto.urlFoto; else noImagen" [src]="producto.urlFoto"
                                    [alt]="producto.nombre" class="w-full h-full object-cover">
                                <ng-template #noImagen>
                                    <div
                                        class="flex items-center justify-center w-full h-full text-xs font-semibold text-center uppercase bg-gray-200 text-gray-600">
                                        SIN IMAGEN
                                    </div>
                                </ng-template>
                            </div>

                            <!-- Nombre del producto -->
                            <mat-card-title class="text-base font-semibold text-center text-gray-800">{{ producto.nombre
                                }}</mat-card-title>

                            <!-- Precio del producto -->
                            <mat-card-content class="text-sm font-medium text-gray-700 mt-1">
                                <span style="color: #056DB6;">
                                    {{ producto.precioVenta | currency: monedaInfo.codigoMoneda:'code':'':
                                    monedaInfo.cultureInfo }}
                                </span>
                            </mat-card-content>

                            <!-- Stock -->
                            <p class="text-xs font-medium mt-1" [ngClass]="{
        'text-red-600': producto.stock <= 0,
        'text-orange-500': producto.stock > 0 && producto.stock <= 5,
        'text-green-600': producto.stock > 5
      }">
                                Stock: {{ producto.stock }}
                            </p>

                            <!-- Botón Agregar -->
                            <!-- Botón Agregar -->
                            <button [disabled]="isCallingInsertService" (click)="seleccionarProducto(producto)"
                                class="mt-4 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-xl shadow hover:bg-blue-700 transition-colors">
                                Agregar
                            </button>
                        </mat-card>
                    </div>
                    <mat-paginator class="mt-6" [length]="allProductByCategoryDataSource?.length" [pageSize]="pageSize"
                        [pageSizeOptions]="[5, 10, 20]" (page)="onPageChange($event)">
                    </mat-paginator>

                </div>
            </div>
            <div class="xl:col-span-1 flex flex-col flex-auto p-6 bg-card rounded-2xl shadow-lg">
                <div class="flex flex-col">
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Total -->
                        <div
                            class="col-span-2 flex flex-col items-center justify-center py-6 px-4 rounded-2xl bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300">
                            <div class="mt-1 text-2xl font-semibold">Total</div>
                            <div class="text-4xl font-bold leading-none tracking-tight">
                                {{ totalVenta | currency: monedaInfo.codigoMoneda:'code':'': monedaInfo.cultureInfo }}
                            </div>
                        </div>
                    </div>
                </div>
                <form [formGroup]="filtroRegistroVentasForm">
                    <!-- Fecha De Venta  -->
                    <div class="flex items-center mt-3">
                        <div class="text font-medium tracking-tight">Fecha De Venta</div>
                    </div>
                    <div class="mt-3 relative">
                        <div class="relative">
                            <mat-form-field class="w-full">
                                <input [disabled]="isCallingInsertService" required (click)="fechaRegistroVenta.open()"
                                    autocomplete="off" matInput [formControlName]="'fechaRegistroVenta'"
                                    [matDatetimepicker]="fechaRegistroVenta" autocomplete="false" />
                                <mat-datetimepicker-toggle [disabled]="isCallingInsertService" matPrefix
                                    [for]="fechaRegistroVenta"></mat-datetimepicker-toggle>
                                <mat-datetimepicker #fechaRegistroVenta type="datetime" openOnFocus="true"
                                    timeInterval="5"></mat-datetimepicker>
                                <mat-error
                                    *ngIf="filtroRegistroVentasForm.get('fechaRegistroVenta').hasError('required')">
                                    Fecha Venta es requerido
                                </mat-error>
                            </mat-form-field>
                        </div>
                    </div>
                </form>
                <!-- Buscar Cliente -->
                <div class="flex items-center">
                    <div class="text font-medium tracking-tight">Buscar Cliente</div>
                </div>
                <div class="mt-3 relative">
                    <div class="relative">
                        <input type="text" [(ngModel)]="parametroBusquedaCliente" [disabled]="isCallingInsertService"
                            (keyup.enter)="buscarCliente()" placeholder="Núm. de Documento o Correo"
                            class="w-full p-3 pl-12 border border-gray-300 rounded-xl bg-white shadow focus:ring focus:ring-primary-300 focus:outline-none dark:bg-gray-800 dark:text-white">
                        <mat-icon class="absolute left-3 top-3 text-gray-500 cursor-pointer"
                            [svgIcon]="'heroicons_mini:magnifying-glass'" (click)="buscarCliente()">
                        </mat-icon>
                    </div>
                </div>
                @if(hayCliente){
                <!-- Panel Datos Cliente -->
                <div
                    class="mt-3 p-2 border-t border-gray-300 bg-gray-100 rounded-lg shadow-md dark:bg-gray-800 relative">

                    <!-- Botón Eliminar -->
                    <button mat-icon-button color="warn" (click)="quitarCliente()"
                        class="absolute top-3 right-3 cursor-pointer text-red-600 hover:text-red-700"
                        [disabled]="isCallingInsertService">
                        <mat-icon [svgIcon]="'heroicons_solid:trash'"></mat-icon>
                    </button>

                    <div class="text-lg font-semibold text-gray-900 dark:text-white">
                        {{ clienteData?.numeroDocumento || 'N/D' }}
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-center mt-3 space-y-2 sm:space-y-0 sm:space-x-4">
                        <div class="flex items-center">
                            <mat-icon class="icon-size-5 text-primary-500"
                                [svgIcon]="'heroicons_solid:user'"></mat-icon>
                            <div class="ml-2 text-md text-gray-700 dark:text-gray-300">
                                {{ clienteData?.nombres?.trim() || '' }}
                                {{ clienteData?.apellidos?.trim() || '' }}
                                {{ clienteData?.correoElectronico?.trim() || '' }}
                            </div>
                        </div>
                    </div>
                </div>

                }
                <!-- Nota adicional -->
                <div class="flex items-center mt-3">
                    <div class="text font-medium tracking-tight">Nota adicional</div>
                </div>
                <div class="mt-3 relative">
                    <textarea [disabled]="isCallingInsertService" id="notaAdicional" [(ngModel)]="notaAdicional"
                        class="w-full p-3 border border-gray-300 rounded-xl bg-white shadow focus:ring focus:ring-primary-300 focus:outline-none dark:bg-gray-800 dark:text-white"
                        rows="3" placeholder="Nota adicional"></textarea>
                </div>

                <!-- Checkbox arriba de Fecha De Venta -->

                <div class="col-span-4">

                    <div class="flex flex-wrap gap-4 mt-4">
                        <input type="checkbox" id="envioSunat" [checked]="flgEnviarComprobante"
                            (change)="onEnviarComprobanteChange($event)" [disabled]="isCallingInsertService"
                            class="w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring focus:ring-primary-300" />
                        <div class="text font-medium tracking-tight">Enviar Comprobante</div>

                    </div>
                </div>

                <!-- Botón Pagar -->
                <div class="flex justify-center mt-6">
                    <button
                        [disabled]="isCallingInsertService || lstProductosSeleccionados.data.length == 0 || !filtroRegistroVentasForm.get('fechaRegistroVenta').value"
                        (click)="InsertAsync()"
                        class="w-full  sm:inline-flex ml-3 sm:w-full sm:h-10 sm:items-center sm:justify-center  transition duration-300 ease-in-out transform hover:scale-105 hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-300"
                        mat-flat-button [color]="'primary'" type="button">
                        <span *ngIf="!isCallingInsertService">
                            Pagar
                        </span>
                        <mat-progress-spinner *ngIf="isCallingInsertService" [diameter]="24" [mode]="'indeterminate'">
                        </mat-progress-spinner>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>